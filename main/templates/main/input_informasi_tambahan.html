<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>OneUML - Additional Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, sans-serif;
    }

    .header {
      height: 64px;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .logo {
      font-weight: 600;
      font-size: 18px;
    }

    .feature-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .feature-card:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .path-row {
      margin-bottom: 12px;
    }

    /* NAV BUTTON FIX */
    .nav-footer {
      position: sticky;
      bottom: 0;
      background: #f9fafb;
      padding: 16px 0;
      border-top: 1px solid #e5e7eb;
      z-index: 500;
    }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="header">
  <div class="logo">OneUML</div>
  <img src="https://via.placeholder.com/40" class="rounded-circle" />
</header>

<!-- CONTENT -->
<main class="container mt-5 mb-5">
  <h3 class="fw-bold">Additional Information</h3>
  <p>Pilih fitur untuk mengisi Use Case Specification.</p>

  <div class="row g-4 mt-4" id="featureGrid"></div>
</main>

<!-- NAVIGATION -->
<div class="container nav-footer">
  <div class="d-flex justify-content-between">

    <button class="btn btn-outline-secondary"
      onclick="window.location.href='/user-story/'">
      ← Back
    </button>

    <button class="btn btn-dark"
      onclick="window.location.href='/use-case-spec/'">
      Next →
    </button>
  </div>
</div>

<!-- MODAL CONTAINER (PENTING) -->
<div id="modalContainer"></div>

<!-- BOOTSTRAP -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const featureGrid = document.getElementById("featureGrid");
const modalContainer = document.getElementById("modalContainer");

/* =============================
   LOAD FEATURE
============================= */
document.addEventListener("DOMContentLoaded", () => {
  const featureList =
    JSON.parse(localStorage.getItem("featureList")) || [];

  if (featureList.length === 0) {
    featureGrid.innerHTML = `
      <div class="text-muted">
        Tidak ada fitur dari tahap sebelumnya.
      </div>`;
    return;
  }

  featureList.forEach((name, index) => {
    createFeature({ id: index + 1, name });
  });
});

/* =============================
   TEMPLATE MODAL
============================= */
function modalTemplate(feature) {
  return `
  <div class="modal fade" id="modalFeature${feature.id}" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">
            Use Case Specification: ${feature.name}
          </h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" class="feature-id" value="${feature.id}" />

          <div class="mb-3">
            <label class="form-label">Summary</label>
            <textarea class="form-control summary" rows="2"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Priority</label>
              <select class="form-select priority">
                <option>Must Have</option>
                <option>Should Have</option>
                <option>Could Have</option>
                <option>Won't Have</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Status</label>
              <select class="form-select status">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Pre-Condition</label>
            <textarea class="form-control precondition" rows="2"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Post-Condition</label>
            <textarea class="form-control postcondition" rows="2"></textarea>
          </div>

          ${pathSection("Basic Path", "basic")}
          ${pathSection("Alternative Path", "alternative")}
          ${pathSection("Exception", "exception")}
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-dark save-btn">
            Save
          </button>
        </div>

      </div>
    </div>
  </div>`;
}

function pathSection(title, type) {
  return `
  <div class="mb-3">
    <label class="form-label">${title}</label>
    <div class="path-container" data-type="${type}"></div>
    <button class="btn btn-sm btn-outline-secondary mt-2 add-path">
      + Tambah Baris
    </button>
  </div>`;
}

/* =============================
   CREATE FEATURE
============================= */
function createFeature(feature) {
  featureGrid.insertAdjacentHTML("beforeend", `
    <div class="col-md-4">
      <div class="feature-card"
        data-bs-toggle="modal"
        data-bs-target="#modalFeature${feature.id}"
        onclick="loadUseCase(${feature.id})">
        <h5>${feature.name}</h5>
      </div>
    </div>`);

  modalContainer.insertAdjacentHTML(
    "beforeend",
    modalTemplate(feature)
  );
}

/* =============================
   LOAD & SAVE
============================= */
function loadUseCase(featureId) {
  const allData =
    JSON.parse(localStorage.getItem("useCaseSpecs")) || {};
  const data = allData[featureId];
  if (!data) return;

  const modal = document.getElementById(`modalFeature${featureId}`);

  modal.querySelector(".summary").value = data.summary || "";
  modal.querySelector(".priority").value = data.priority || "Must Have";
  modal.querySelector(".status").value = data.status || "Active";
  modal.querySelector(".precondition").value = data.precondition || "";
  modal.querySelector(".postcondition").value = data.postcondition || "";

  fillPath(modal, "basic", data.basicPath);
  fillPath(modal, "alternative", data.alternativePath);
  fillPath(modal, "exception", data.exceptionPath);
}

function fillPath(modal, type, paths = []) {
  const container = modal.querySelector(`.path-container[data-type="${type}"]`);
  container.innerHTML = "";
  paths.forEach(p => addPathRow(container, p.actor, p.system));
}

function addPathRow(container, actor = "", system = "") {
  const div = document.createElement("div");
  div.className = "row path-row";
  div.innerHTML = `
    <div class="col-md-6">
      <textarea class="form-control actor" rows="2">${actor}</textarea>
    </div>
    <div class="col-md-6">
      <textarea class="form-control system" rows="2">${system}</textarea>
    </div>`;
  container.appendChild(div);
}

document.addEventListener("click", e => {
  if (e.target.classList.contains("add-path")) {
    addPathRow(e.target.previousElementSibling);
  }

  if (e.target.classList.contains("save-btn")) {
    const modal = e.target.closest(".modal");
    const featureId = modal.querySelector(".feature-id").value;

    const allData =
      JSON.parse(localStorage.getItem("useCaseSpecs")) || {};

    allData[featureId] = {
      summary: modal.querySelector(".summary").value,
      priority: modal.querySelector(".priority").value,
      status: modal.querySelector(".status").value,
      precondition: modal.querySelector(".precondition").value,
      postcondition: modal.querySelector(".postcondition").value,
      basicPath: collectPath(modal, "basic"),
      alternativePath: collectPath(modal, "alternative"),
      exceptionPath: collectPath(modal, "exception"),
    };

    localStorage.setItem("useCaseSpecs", JSON.stringify(allData));
    bootstrap.Modal.getInstance(modal).hide();
    alert("Data berhasil disimpan ✅");
  }
});

function collectPath(modal, type) {
  return [...modal.querySelectorAll(
    `.path-container[data-type="${type}"] .path-row`
  )].map(r => ({
    actor: r.querySelector(".actor").value,
    system: r.querySelector(".system").value,
  }));
}
</script>

</body>
</html>