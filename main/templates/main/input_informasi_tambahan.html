<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>One UML - Additional Information</title>
    <style>
      /* Global Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f9fafb;
        color: #111827;
        line-height: 1.5;
      }

      /* Header */
      header {
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 2rem;
      }

      footer {
        background: #fff;
        border-top: 1px solid #e5e7eb;
        padding: 1rem 2rem;
        margin-top: 2rem;
      }

      main {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .card {
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 24px;
        margin-bottom: 24px;
      }

      .btn {
        background-color: #111827;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }

      .btn:hover {
        background-color: #1f2937;
      }

      .btn-outline {
        background-color: white;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .btn-outline:hover {
        background-color: #f9fafb;
      }

      .btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
      }

      .empty-state {
        color: #6b7280;
        padding: 32px;
        text-align: center;
      }

      .empty-state i {
        font-size: 48px;
        margin-bottom: 16px;
        display: block;
      }

      .navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-icon {
        width: 24px;
        height: 24px;
        background-color: #111827;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logo-text {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
      }

      /* Feature Card Styles */
      .feature-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        display: flex;
        align-items: center;
        min-height: 80px;
      }

      .feature-card:hover {
        border-color: #d1d5db;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .feature-title {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
      }

      .feature-info {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
      }

      .feature-complete {
        border-left: 4px solid #10b981;
      }

      .feature-incomplete {
        border-left: 4px solid #f59e0b;
      }

      /* Grid Layout */
      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
        margin-top: 20px;
      }

      /* Modal Styles */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-container {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
      }

      .modal-close:hover {
        background-color: #f3f4f6;
      }

      .modal-body {
        padding: 24px;
        flex: 1;
        overflow-y: auto;
      }

      .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        margin-bottom: 6px;
      }

      .form-input,
      .form-select,
      .form-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background-color: #ffffff;
        transition: border-color 0.2s ease;
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
        outline: none;
        border-color: #111827;
      }

      /* Path Section Styles */
      .path-section {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 1px solid #e5e7eb;
      }

      .path-section-title {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 12px;
      }

      .path-row {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
        align-items: flex-start;
      }

      .path-column {
        flex: 1;
      }

      .path-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
        display: block;
      }

      .add-path-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        background: none;
        border: 1px dashed #d1d5db;
        color: #6b7280;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
        margin-top: 8px;
      }

      .add-path-btn:hover {
        border-color: #111827;
        color: #111827;
      }

      .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 6px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-info {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #374151;
      }

      .delete-path-btn {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        margin-top: 4px;
      }

      .delete-path-btn:hover {
        background-color: #fef2f2;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">
        <div class="logo-icon">
          <span style="color: white; font-size: 12px; font-weight: bold"
            >‚ö°</span
          >
        </div>
        <span class="logo-text">One UML</span>
      </div>
    </header>

    <main>
      <div style="margin-bottom: 32px">
        <h1
          style="
            font-size: 28px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
          "
        >
          Additional Information
        </h1>
        <p style="color: #6b7280; font-size: 14px">
          Click cards below to complete Use Case details.
        </p>
      </div>

      <!-- Status Info -->
      <div id="statusInfo" class="status-info">
        <span id="completedCount">0</span> of <span id="totalCount">0</span> use
        cases completed
      </div>

      <!-- Features Grid -->
      <div class="card">
        <div style="margin-bottom: 16px">
          <h3 style="font-size: 18px; font-weight: 600; color: #111827">
            Use Cases
          </h3>
          <p style="color: #6b7280; font-size: 14px; margin-top: 4px">
            Click to add specifications
          </p>
        </div>

        <div id="featuresGrid" class="features-grid">
          <!-- Features will be dynamically added here -->
        </div>
      </div>

      <!-- Navigation -->
      <div class="navigation">
        <button class="btn btn-outline" id="backButton">‚Üê Back</button>
        <button class="btn" id="nextButton" disabled>Next ‚Üí</button>
      </div>
    </main>

    <footer>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <p style="font-size: 12px; color: #6b7280">
          ¬© 2025 One UML. All rights reserved.
        </p>
        <div style="display: flex; gap: 24px">
          <a
            href="#"
            style="font-size: 12px; color: #6b7280; text-decoration: none"
            >Help</a
          >
          <a
            href="#"
            style="font-size: 12px; color: #6b7280; text-decoration: none"
            >Privacy</a
          >
          <a
            href="#"
            style="font-size: 12px; color: #6b7280; text-decoration: none"
            >Terms</a
          >
        </div>
      </div>
    </footer>

    <!-- Modal Container -->
    <div id="modalContainer" class="modal-overlay"></div>

    <script>
      // Data management
      let features = [];
      let currentFeatureId = null;

      // Load data from storage
      function loadDataFromStorage() {
        console.log("Loading data from storage...");

        // PERBAIKAN 1: Prioritas Utama adalah Data dari Database (Django)
        try {
          const djangoDataElement =
            document.getElementById("djangoUseCaseData");
          if (djangoDataElement && djangoDataElement.textContent) {
            const djangoData = JSON.parse(djangoDataElement.textContent);
            if (djangoData && djangoData.length > 0) {
              // Konversi format ID database ke format frontend jika perlu, atau gunakan langsung
              // Kita gunakan fungsi helper yang sudah ada
              features = formatDjangoDataForFeatures(djangoData);
              console.log(
                "‚úÖ Loaded from Database (Django):",
                features.length,
                "features"
              );

              // Update localStorage agar sinkron
              localStorage.setItem("useCaseDetails", JSON.stringify(features));
              return features;
            }
          }
        } catch (e) {
          console.error("Error parsing Django data:", e);
        }

        // ... (kode sisa localStorage biarkan sebagai fallback) ...
        // Priority 2: Check localStorage...
        const savedFeatures = localStorage.getItem("useCaseDetails");
        // ... dst
      }

      // Format Django data into features
      function formatDjangoDataForFeatures(djangoData) {
        if (!djangoData || !Array.isArray(djangoData)) {
          return [];
        }

        const uniqueFeatures = new Map();

        djangoData.forEach((item) => {
          if (!item || !item.name) return;

          const featureKey = item.name.trim().toLowerCase();
          if (!uniqueFeatures.has(featureKey)) {
            uniqueFeatures.set(featureKey, {
              id: `feature-${Date.now()}-${Math.random()
                .toString(36)
                .substr(2, 9)}`,
              name: item.name,
              summary: item.summary || "",
              priority: item.priority || "Should Have",
              status: item.status || "Active",
              precondition: item.precondition || "",
              postcondition: item.postcondition || "",
              basicPath: item.basicPath || [{ actor: "", system: "" }],
              alternativePath: item.alternativePath || [],
              exceptionPath: item.exceptionPath || [],
              actors: item.actors || [],
            });
          }
        });

        return Array.from(uniqueFeatures.values());
      }

      // Format use cases into features (for old format)
      function formatUseCasesForFeatures(useCasesData) {
        if (!useCasesData || !Array.isArray(useCasesData)) {
          return [];
        }

        const uniqueFeatures = new Map();

        useCasesData.forEach((useCase) => {
          if (!useCase || !useCase.feature) return;

          const featureKey = useCase.feature.trim().toLowerCase();
          if (!uniqueFeatures.has(featureKey)) {
            uniqueFeatures.set(featureKey, {
              id: `feature-${Date.now()}-${Math.random()
                .toString(36)
                .substr(2, 9)}`,
              name: useCase.feature,
              summary: useCase.purpose || "",
              priority: "Should Have",
              status: "Active",
              precondition: "",
              postcondition: "",
              basicPath: [{ actor: "", system: "" }],
              alternativePath: [],
              exceptionPath: [],
              actors: useCase.actor ? [useCase.actor] : [],
            });
          } else {
            // Add actor if not already in list
            if (
              useCase.actor &&
              !uniqueFeatures.get(featureKey).actors.includes(useCase.actor)
            ) {
              uniqueFeatures.get(featureKey).actors.push(useCase.actor);
            }
          }
        });

        return Array.from(uniqueFeatures.values());
      }

      // Render features grid
      function renderFeaturesGrid() {
        const grid = document.getElementById("featuresGrid");

        if (!features || features.length === 0) {
          grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i>üìã</i>
                        <p>No use cases found.</p>
                        <p>Please go back and define actors and features first.</p>
                    </div>
                `;
          updateStatusInfo();
          return;
        }

        grid.innerHTML = "";

        features.forEach((feature) => {
          const isComplete = checkIfFeatureComplete(feature);

          const featureCard = document.createElement("div");
          featureCard.className = `feature-card ${
            isComplete ? "feature-complete" : "feature-incomplete"
          }`;
          featureCard.setAttribute("data-feature-id", feature.id);

          featureCard.innerHTML = `
                    <div style="flex: 1;">
                        <div class="feature-title">${feature.name}</div>
                        <div class="feature-info">
                            ${
                              feature.actors && feature.actors.length > 0
                                ? feature.actors.length +
                                  " actor" +
                                  (feature.actors.length !== 1 ? "s" : "") +
                                  " ‚Ä¢ "
                                : ""
                            }
                            ${
                              feature.summary
                                ? feature.summary.substring(0, 50) + "..."
                                : "No summary"
                            }
                            ${
                              isComplete ? " ‚Ä¢ ‚úÖ Complete" : " ‚Ä¢ ‚ö†Ô∏è Incomplete"
                            }
                        </div>
                    </div>
                `;

          featureCard.addEventListener("click", () =>
            openFeatureModal(feature.id)
          );
          grid.appendChild(featureCard);
        });

        updateStatusInfo();
      }

      // Check if a feature is complete
      function checkIfFeatureComplete(feature) {
        if (!feature) return false;

        // Check required fields
        if (!feature.precondition || feature.precondition.trim() === "")
          return false;
        if (!feature.postcondition || feature.postcondition.trim() === "")
          return false;

        // Basic path must have at least one valid step
        if (!feature.basicPath || feature.basicPath.length === 0) return false;
        const hasValidBasicStep = feature.basicPath.some(
          (step) =>
            (step.actor && step.actor.trim() !== "") ||
            (step.system && step.system.trim() !== "")
        );

        return hasValidBasicStep;
      }

      // Update status info
      function updateStatusInfo() {
        const totalCount = features.length;
        const completedCount = features.filter((f) =>
          checkIfFeatureComplete(f)
        ).length;

        document.getElementById("totalCount").textContent = totalCount;
        document.getElementById("completedCount").textContent = completedCount;

        // Enable/disable next button
        const nextButton = document.getElementById("nextButton");
        if (totalCount > 0 && completedCount === totalCount) {
          nextButton.disabled = false;
          nextButton.style.backgroundColor = "#111827";
        } else {
          nextButton.disabled = true;
          nextButton.style.backgroundColor = "#9ca3af";
        }
      }

      // Open feature modal
      function openFeatureModal(featureId) {
        const feature = features.find((f) => f.id === featureId);
        if (!feature) return;

        currentFeatureId = featureId;

        const modalHTML = createModalHTML(feature);
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.innerHTML = modalHTML;
        modalContainer.classList.add("active");

        setupModalListeners();
      }

      // Create modal HTML
      function createModalHTML(feature) {
        return `
                <div class="modal-container">
                    <div class="modal-header">
                        <div class="modal-title">${feature.name}</div>
                        <button class="modal-close" id="modalCloseBtn">√ó</button>
                    </div>
                    
                    <div class="modal-body">
                        <input type="hidden" id="featureId" value="${
                          feature.id
                        }">
                        
                        <div class="form-group">
                            <label class="form-label">Summary</label>
                            <textarea class="form-textarea" id="summary" rows="2" placeholder="Brief description of the use case...">${
                              feature.summary || ""
                            }</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 1;">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="priority">
                                    <option value="Must Have" ${
                                      feature.priority === "Must Have"
                                        ? "selected"
                                        : ""
                                    }>Must Have</option>
                                    <option value="Should Have" ${
                                      feature.priority === "Should Have"
                                        ? "selected"
                                        : ""
                                    }>Should Have</option>
                                    <option value="Could Have" ${
                                      feature.priority === "Could Have"
                                        ? "selected"
                                        : ""
                                    }>Could Have</option>
                                    <option value="Won't Have" ${
                                      feature.priority === "Won't Have"
                                        ? "selected"
                                        : ""
                                    }>Won't Have</option>
                                </select>
                            </div>
                            
                            <div style="flex: 1;">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status">
                                    <option value="Active" ${
                                      feature.status === "Active"
                                        ? "selected"
                                        : ""
                                    }>Active</option>
                                    <option value="Inactive" ${
                                      feature.status === "Inactive"
                                        ? "selected"
                                        : ""
                                    }>Inactive</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Pre-Condition <small style="color: #6b7280;">(Required)</small></label>
                            <textarea class="form-textarea" id="precondition" rows="2" placeholder="What must be true before this use case starts...">${
                              feature.precondition || ""
                            }</textarea>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Post-Condition <small style="color: #6b7280;">(Required)</small></label>
                            <textarea class="form-textarea" id="postcondition" rows="2" placeholder="What will be true after this use case completes...">${
                              feature.postcondition || ""
                            }</textarea>
                        </div>
                        
                        ${createPathSection(
                          "Basic Path",
                          "basic",
                          feature.basicPath || [{ actor: "", system: "" }],
                          true
                        )}
                        ${createPathSection(
                          "Alternative Path",
                          "alternative",
                          feature.alternativePath || [],
                          false
                        )}
                        ${createPathSection(
                          "Exception Path",
                          "exception",
                          feature.exceptionPath || [],
                          false
                        )}
                    </div>
                    
                    <div class="modal-footer">
                        <button class="btn btn-outline" id="cancelBtn">Cancel</button>
                        <button class="btn" id="saveBtn">Save</button>
                    </div>
                </div>
            `;
      }

      // Create path section HTML
      function createPathSection(title, type, paths, isRequired = false) {
        let pathRows = "";

        if (paths && paths.length > 0) {
          paths.forEach((path, index) => {
            pathRows += `
                        <div class="path-row" data-index="${index}">
                            <div class="path-column">
                                <span class="path-label">Actor Action ${
                                  isRequired && index === 0
                                    ? '<small style="color: #6b7280;">(Required)</small>'
                                    : ""
                                }</span>
                                <textarea class="form-textarea path-actor" rows="2" placeholder="What the actor does...">${
                                  path.actor || ""
                                }</textarea>
                            </div>
                            <div class="path-column">
                                <span class="path-label">System Response ${
                                  isRequired && index === 0
                                    ? '<small style="color: #6b7280;">(Required)</small>'
                                    : ""
                                }</span>
                                <textarea class="form-textarea path-system" rows="2" placeholder="How the system responds...">${
                                  path.system || ""
                                }</textarea>
                            </div>
                            ${
                              index > 0
                                ? `
                            <div style="align-self: flex-end;">
                                <button class="delete-path-btn" data-type="${type}" data-index="${index}">üóëÔ∏è</button>
                            </div>
                            `
                                : ""
                            }
                        </div>
                    `;
          });
        } else {
          pathRows = `
                    <div class="path-row" data-index="0">
                        <div class="path-column">
                            <span class="path-label">Actor Action ${
                              isRequired
                                ? '<small style="color: #6b7280;">(Required)</small>'
                                : ""
                            }</span>
                            <textarea class="form-textarea path-actor" rows="2" placeholder="What the actor does..."></textarea>
                        </div>
                        <div class="path-column">
                            <span class="path-label">System Response ${
                              isRequired
                                ? '<small style="color: #6b7280;">(Required)</small>'
                                : ""
                            }</span>
                            <textarea class="form-textarea path-system" rows="2" placeholder="How the system responds..."></textarea>
                        </div>
                    </div>
                `;
        }

        return `
                <div class="path-section">
                    <div class="path-section-title">${title} ${
          isRequired
            ? '<small style="color: #6b7280;">(At least one step required)</small>'
            : ""
        }</div>
                    <div class="path-container" data-type="${type}">
                        ${pathRows}
                    </div>
                    <button class="add-path-btn" data-type="${type}">
                        <span style="font-size: 16px;">+</span>
                        Add Row
                    </button>
                </div>
            `;
      }

      // Setup modal event listeners
      function setupModalListeners() {
        // Close modal buttons
        document
          .getElementById("modalCloseBtn")
          .addEventListener("click", closeModal);
        document
          .getElementById("cancelBtn")
          .addEventListener("click", closeModal);

        // Add path buttons
        document.querySelectorAll(".add-path-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const type = e.target.getAttribute("data-type");
            const container = document.querySelector(
              `.path-container[data-type="${type}"]`
            );
            const rowCount = container.querySelectorAll(".path-row").length;

            container.insertAdjacentHTML(
              "beforeend",
              `
                        <div class="path-row" data-index="${rowCount}">
                            <div class="path-column">
                                <span class="path-label">Actor Action</span>
                                <textarea class="form-textarea path-actor" rows="2" placeholder="What the actor does..."></textarea>
                            </div>
                            <div class="path-column">
                                <span class="path-label">System Response</span>
                                <textarea class="form-textarea path-system" rows="2" placeholder="How the system responds..."></textarea>
                            </div>
                            <div style="align-self: flex-end;">
                                <button class="delete-path-btn" data-type="${type}" data-index="${rowCount}">üóëÔ∏è</button>
                            </div>
                        </div>
                    `
            );

            // Add delete button listener for new row
            const newDeleteBtn = container.querySelector(
              `.delete-path-btn[data-index="${rowCount}"]`
            );
            if (newDeleteBtn) {
              newDeleteBtn.addEventListener("click", function () {
                const type = this.getAttribute("data-type");
                const index = parseInt(this.getAttribute("data-index"));
                deletePathRow(type, index);
              });
            }
          });
        });

        // Delete path buttons (for existing rows)
        document.querySelectorAll(".delete-path-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const type = this.getAttribute("data-type");
            const index = parseInt(this.getAttribute("data-index"));
            deletePathRow(type, index);
          });
        });

        // Save button
        document
          .getElementById("saveBtn")
          .addEventListener("click", saveFeature);

        // Close modal when clicking outside
        document
          .getElementById("modalContainer")
          .addEventListener("click", (e) => {
            if (e.target.id === "modalContainer") {
              closeModal();
            }
          });
      }

      // Delete a path row
      function deletePathRow(type, index) {
        const container = document.querySelector(
          `.path-container[data-type="${type}"]`
        );
        const row = container.querySelector(`.path-row[data-index="${index}"]`);
        if (row) {
          row.remove();

          // Re-index remaining rows
          const rows = container.querySelectorAll(".path-row");
          rows.forEach((row, newIndex) => {
            row.setAttribute("data-index", newIndex);
            const deleteBtn = row.querySelector(".delete-path-btn");
            if (deleteBtn) {
              deleteBtn.setAttribute("data-index", newIndex);
            }
          });
        }
      }

      // Close modal
      function closeModal() {
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.classList.remove("active");
        currentFeatureId = null;
      }

      // Save feature data
      async function saveFeature() {
        const featureId = document.getElementById("featureId").value;
        const feature = features.find((f) => f.id === featureId);

        if (!feature) {
          alert("Feature not found!");
          return;
        }

        // Collect data from form
        feature.summary = document.getElementById("summary").value.trim();
        feature.priority = document.getElementById("priority").value;
        feature.status = document.getElementById("status").value;
        feature.precondition = document
          .getElementById("precondition")
          .value.trim();
        feature.postcondition = document
          .getElementById("postcondition")
          .value.trim();

        // Validate required fields
        if (!feature.precondition) {
          alert("Please fill in the Pre-Condition field");
          document.getElementById("precondition").focus();
          return;
        }

        if (!feature.postcondition) {
          alert("Please fill in the Post-Condition field");
          document.getElementById("postcondition").focus();
          return;
        }

        // Collect path data
        ["basic", "alternative", "exception"].forEach((type) => {
          const container = document.querySelector(
            `.path-container[data-type="${type}"]`
          );
          const rows = container.querySelectorAll(".path-row");
          const paths = [];

          rows.forEach((row) => {
            const actor = row.querySelector(".path-actor").value.trim();
            const system = row.querySelector(".path-system").value.trim();
            paths.push({ actor, system });
          });

          feature[`${type}Path`] = paths;
        });

        // Validate basic path has at least one valid step
        const hasValidBasicStep = feature.basicPath.some(
          (step) =>
            (step.actor && step.actor.trim() !== "") ||
            (step.system && step.system.trim() !== "")
        );

        if (!hasValidBasicStep) {
          alert(
            "Basic Path must have at least one step with Actor Action or System Response"
          );
          return;
        }

        // Show loading
        const saveBtn = document.getElementById("saveBtn");
        const originalText = saveBtn.textContent;
        saveBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';
        saveBtn.disabled = true;

        try {
          // Save to localStorage
          localStorage.setItem("useCaseDetails", JSON.stringify(features));
          console.log("‚úÖ Saved to localStorage:", features);

          // Also save to database via API if needed
          await saveToDatabase(feature);

          // Update UI
          renderFeaturesGrid();

          // Close modal
          closeModal();

          // Show success
          setTimeout(() => {
            alert("‚úÖ Feature saved successfully!");
          }, 100);
        } catch (error) {
          console.error("Error saving:", error);
          alert("Error saving data: " + error.message);
        } finally {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }

      // Save to database via API
      async function saveToDatabase(feature) {
        try {
          // PERBAIKAN 2: Gunakan URL API yang benar sesuai urls.py ('api/save_usecase_spec/')
          // Sebelumnya '/save-usecase-spec/' salah karena di urls.py ada prefix 'api/'
          const response = await fetch("/api/save_usecase_spec/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              // Pastikan fungsi getCookie ada
              "X-CSRFToken": getCookie("csrftoken"),
            },
            // Format body ini sudah benar sesuai views.py
            body: JSON.stringify({
              [feature.id]: {
                // Gunakan ID atau Nama unik sebagai key
                featureName: feature.name,
                summary: feature.summary,
                priority: feature.priority,
                status: feature.status,
                precondition: feature.precondition,
                postcondition: feature.postcondition,
                basicPath: feature.basicPath,
                alternativePath: feature.alternativePath,
                exceptionPath: feature.exceptionPath,
              },
            }),
          });

          const result = await response.json();

          if (result.status === "success") {
            console.log("‚úÖ Saved to database:", result.message);
          } else {
            console.warn("‚ö†Ô∏è Database save warning:", result.message);
          }
        } catch (error) {
          console.error("‚ùå Database save error:", error);
          // Don't throw error here - localStorage backup is sufficient
        }
      }

      // Get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Prepare data for next page
      function prepareDataForNextPage() {
        // Format features for use-case-spec page
        const formattedFeatures = {};
        features.forEach((feature, index) => {
          formattedFeatures[`feature_${index}`] = {
            featureName: feature.name,
            summary: feature.summary || "",
            priority: feature.priority || "Should Have",
            status: feature.status || "Active",
            precondition: feature.precondition || "",
            postcondition: feature.postcondition || "",
            basicPath: feature.basicPath || [],
            alternativePath: feature.alternativePath || [],
            exceptionPath: feature.exceptionPath || [],
          };
        });
        return formattedFeatures;
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Page loaded");

        // Load data
        features = loadDataFromStorage();
        renderFeaturesGrid();

        // Event listeners
        document.getElementById("backButton").addEventListener("click", () => {
          // Save data before leaving
          if (features.length > 0) {
            localStorage.setItem("useCaseDetails", JSON.stringify(features));
          }
          window.location.href = "/use-case/";
        });

        document
          .getElementById("nextButton")
          .addEventListener("click", async () => {
            // Validate all features are complete
            const incompleteFeatures = features.filter(
              (f) => !checkIfFeatureComplete(f)
            );

            if (incompleteFeatures.length > 0) {
              const featureNames = incompleteFeatures
                .map((f) => f.name)
                .join(", ");
              alert(
                `Please complete all use cases before proceeding.\n\nIncomplete: ${featureNames}`
              );
              return;
            }

            // Show loading
            const nextBtn = document.getElementById("nextButton");
            const originalText = nextBtn.innerHTML;
            nextBtn.innerHTML =
              '<span class="loading-spinner"></span>Preparing...';
            nextBtn.disabled = true;

            try {
              // Format data for next page
              const formattedData = prepareDataForNextPage();

              // Save to localStorage in the format expected by use-case-spec
              localStorage.setItem(
                "formattedUseCaseDetails",
                JSON.stringify(formattedData)
              );

              // Save to sessionStorage as backup
              sessionStorage.setItem(
                "useCaseDetails",
                JSON.stringify(features)
              );

              // Navigate to next page with data in URL
              const dataString = encodeURIComponent(JSON.stringify(features));
              window.location.href = `/use-case-spec/?data=${dataString}`;
            } catch (error) {
              console.error("Error:", error);
              alert("Error preparing data: " + error.message);

              // Restore button
              nextBtn.innerHTML = originalText;
              nextBtn.disabled = false;
            }
          });
      });
    </script>

    <!-- Hidden element for Django data -->
    {% if use_cases_json %}
    <div id="djangoUseCaseData" style="display: none">{{ use_cases_json }}</div>
    {% endif %}
  </body>
</html>
