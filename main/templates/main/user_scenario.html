<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Scenario</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* CSS SAMA PERSIS KAYA PUNYAMU, SAYA RINGKAS BIAR RAPI */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; display: flex; justify-content: center; padding: 40px 20px; color: #1f2937; }
        .container { background: #fff; width: 100%; max-width: 1200px; padding: 40px 48px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: #6b7280; margin-bottom: 32px; }
        
        /* CARD STYLES */
        .user-story-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .user-story-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; cursor: pointer; }
        .user-story-header:hover { background: #f9fafb; }
        .story-number { width: 36px; height: 36px; border-radius: 50%; background: #3b82f6; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 16px; flex-shrink: 0; }
        .toggle-icon { width: 24px; transition: transform 0.2s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .user-story-content { padding: 24px; border-top: 1px solid #e5e7eb; display: block; }
        .user-story-content.collapsed { display: none; }

        .scenario-type-card { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 16px; background: #fafafa; }
        .scenario-type-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .type-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; margin-right: 10px; }
        .type-badge.positive { background: #d1fae5; color: #065f46; }
        .type-badge.negative { background: #fee2e2; color: #991b1b; }
        
        .scenario-type-content { padding: 16px 20px; }
        .scenario-type-content.collapsed { display: none; }
        
        /* STEP ROW DINAMIS */
        .step-row { display: grid; grid-template-columns: 40px 120px 1fr 1fr 40px; gap: 12px; margin-bottom: 12px; align-items: center; }
        select, input { width: 100%; height: 38px; padding: 6px; border-radius: 6px; border: 1px solid #d1d5db; }
        .add-scenario-btn { width: 100%; padding: 8px; border: 1px dashed #d1d5db; background: #fff; cursor: pointer; margin-top: 8px; }
        .delete-btn { color: #dc3545; cursor: pointer; text-align: center; font-weight: bold; border:none; background:none; font-size: 18px; }
        
        .navigation { display: flex; justify-content: space-between; margin-top: 32px; }
        .nav-btn { padding: 12px 24px; background: #000; color: #fff; border-radius: 6px; text-decoration: none; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        {% csrf_token %}
        <h1>User Scenario</h1>
        <p class="subtitle">Define positive and negative scenarios for each User Story.</p>

        {% if specs %}
            {% for spec in specs %}
            <div class="user-story-card" data-spec-id="{{ spec.id }}">
                <div class="user-story-header" onclick="toggleUserStory(this)">
                    <div style="display:flex; align-items:center;">
                        <div class="story-number">{{ forloop.counter }}</div>
                        <div class="story-text">
                            <strong>{{ spec.feature_name }}</strong><br>
                            <span style="font-size:13px; color:#666; font-weight:normal;">
                                {{ spec.summary_description|default:"-" }}
                            </span>
                        </div>
                    </div>
                    <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </div>

                <div class="user-story-content"> <div class="scenario-type-card" data-type="Positive">
                        <div class="scenario-type-header" onclick="toggleScenarioType(this)">
                            <div><span class="type-badge positive">POSITIVE</span> Positive Scenario</div>
                            <svg class="toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="scenario-type-content">
                            <div class="step-container"></div> 
                            <button class="add-scenario-btn" onclick="addStep(this)">+ ADD STEP</button>
                        </div>
                    </div>

                    <div class="scenario-type-card" data-type="Negative">
                        <div class="scenario-type-header" onclick="toggleScenarioType(this)">
                            <div><span class="type-badge negative">NEGATIVE</span> Negative Scenario</div>
                            <svg class="toggle-icon collapsed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </div>
                        <div class="scenario-type-content collapsed">
                            <div class="step-container"></div>
                            <button class="add-scenario-btn" onclick="addStep(this)">+ ADD STEP</button>
                        </div>
                    </div>

                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align:center; padding:40px;">
                <p>Belum ada Use Case. Silakan input Use Case dulu.</p>
            </div>
        {% endif %}

        <div class="navigation">
            <a href="/input_gui/G02/" class="nav-btn" style="background:#6c757d">&lt; BACK</a>
            <button onclick="saveAllScenarios()" class="nav-btn">NEXT &gt;</button>
        </div>
    </div>

    <script>
    // 1. AMBIL DATA DARI DJANGO
    // Gunakan try-catch agar jika data kosong, aplikasi tidak crash
    let guiData = { pages: [], elements: [] };
    try {
        guiData = JSON.parse('{{ gui_data_json|escapejs }}');
        console.log("GUI Data Loaded:", guiData);
    } catch (e) {
        console.error("Gagal memuat data GUI:", e);
    }

    // 2. FUNGSI TOGGLE (Biar bisa dibuka-tutup)
    function toggleUserStory(header) {
        const content = header.nextElementSibling;
        header.querySelector('.toggle-icon').classList.toggle('collapsed');
        content.classList.toggle('collapsed');
    }

    // FIX: Fungsi ini yang membuat Negative Scenario bisa dibuka
    function toggleScenarioType(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.toggle-icon');
        content.classList.toggle('collapsed');
        if(icon) icon.classList.toggle('collapsed');
    }

    // 3. MANAJEMEN BARIS STEP
    function addStep(btn) {
        const container = btn.previousElementSibling;
        const stepNum = container.children.length + 1;
        
        const row = document.createElement('div');
        row.className = 'step-row';
        row.innerHTML = `
            <div class="step-num" style="text-align:center; font-weight:bold;">${stepNum}</div>
            <select class="select-condition">
                <option value="Given">Given</option>
                <option value="When">When</option>
                <option value="Then">Then</option>
                <option value="And">And</option>
            </select>
            <select class="select-activity" onchange="updateTargetOptions(this)">
                <option value="">-- Activity --</option>
                <option value="page">I am on page</option>
                <option value="click">User click</option>
                <option value="input">User input</option>
                <option value="custom">Other / Custom</option>
            </select>
            <select class="select-target" disabled>
                <option value="">-- Target --</option>
            </select>
            <button class="delete-btn" onclick="removeStep(this)">Ã—</button>
        `;
        container.appendChild(row);
    }

    function removeStep(btn) {
        const container = btn.closest('.step-container');
        btn.parentElement.remove();
        if(container) renumberSteps(container);
    }

    function renumberSteps(container) {
        container.querySelectorAll('.step-num').forEach((el, index) => {
            el.innerText = index + 1;
        });
    }

    // 4. LOGIC PINTAR DROPDOWN TARGET
    function updateTargetOptions(activitySelect) {
        const row = activitySelect.parentElement;
        const targetSelect = row.querySelector('.select-target');
        const activity = activitySelect.value;

        targetSelect.innerHTML = '<option value="">-- Target --</option>';
        targetSelect.disabled = false;
        targetSelect.style.display = 'block';

        // Hapus input custom jika ada
        const existingInput = row.querySelector('.custom-target-input');
        if(existingInput) existingInput.remove();

        if (activity === 'custom') {
            targetSelect.style.display = 'none';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type custom...';
            input.className = 'custom-target-input';
            row.insertBefore(input, row.lastElementChild);
            return;
        }

        if (activity === 'page') {
            // Tampilkan daftar halaman (Page)
            guiData.pages.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = "[Page] " + p.name;
                targetSelect.appendChild(opt);
            });
        } else {
            // Tampilkan daftar elemen (Button/Text/dll)
            // Longgarkan filter agar semua elemen muncul dulu untuk testing
            guiData.elements.forEach(el => {
                const opt = document.createElement('option');
                opt.value = el.id;
                opt.text = `[${el.type}] ${el.name} (on ${el.page})`;
                targetSelect.appendChild(opt);
            });
        }
    }

    // 5. SIMPAN KE DATABASE
    function saveAllScenarios() {
        const payload = [];
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        document.querySelectorAll('.user-story-card').forEach(card => {
            const specId = card.dataset.specId;
            card.querySelectorAll('.scenario-type-card').forEach(typeCard => {
                const type = typeCard.dataset.type;
                const steps = [];

                typeCard.querySelectorAll('.step-row').forEach(row => {
                    const activity = row.querySelector('.select-activity').value;
                    if(!activity) return;

                    let targetId = null;
                    let targetText = "";

                    if(activity === 'custom') {
                        targetText = row.querySelector('.custom-target-input').value;
                    } else {
                        const targetSelect = row.querySelector('.select-target');
                        targetId = targetSelect.value;
                        targetText = targetSelect.options[targetSelect.selectedIndex].text;
                    }

                    steps.push({
                        condition: row.querySelector('.select-condition').value,
                        activity: activity,
                        target_id: targetId,
                        target_text: targetText
                    });
                });

                if(steps.length > 0) {
                    payload.push({ spec_id: specId, type: type, steps: steps });
                }
            });
        });

        fetch('/save_scenarios/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken 
            },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // alert("Skenario Berhasil Disimpan!");
                window.location.href = "{% url 'main:scenario_result' %}";
            } else {
                alert("Error: " + data.message);
            }
        });
    }

    // Init otomatis 1 baris
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.add-scenario-btn').forEach(btn => btn.click());
    });
</script>
</body>
</html>