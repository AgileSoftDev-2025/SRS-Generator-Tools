<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One UML - Generate Use Case Diagram</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            color: #111827;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        header {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 2rem;
        }
        
        footer {
            background: #fff;
            border-top: 1px solid #e5e7eb;
            padding: 1rem 2rem;
            margin-top: 2rem;
        }
        
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .btn {
            background-color: #111827;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #1f2937;
        }
        
        .btn-outline {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }
        
        .btn-outline:hover {
            background-color: #f9fafb;
        }
        
        .diagram-container {
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f9fafb;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .diagram-image {
            max-width: 100%;
            max-height: 350px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        
        .empty-state {
            color: #6b7280;
            padding: 32px;
            text-align: center;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-title {
            font-size: 20px;
            color: #111827;
            font-weight: 600;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        .info-text {
            background: #eff6ff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
            font-size: 14px;
        }
        
        .use-case-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .use-case-table th, .use-case-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .use-case-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #111827;
        }
        
        .use-case-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .user-story-section {
            margin-top: 30px;
        }
        
        .user-story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .user-story-title {
            font-size: 20px;
            color: #111827;
            font-weight: 600;
        }
        
        .user-story-list {
            list-style-type: none;
        }
        
        .user-story-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .success-check {
            color: #10b981;
            margin-top: 3px;
            font-weight: bold;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logo-icon {
            width: 24px;
            height: 24px;
            background-color: #111827;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-text {
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }
        
        /* Alert untuk debug */
        .debug-alert {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
<header>
    <div class="logo">
        <div class="logo-icon">
            <span style="color: white; font-size: 12px; font-weight: bold;">‚ö°</span>
        </div>
        <span class="logo-text">One UML</span>
    </div>
</header>

<main>
    <div style="margin-bottom: 32px;">
        <h1 style="font-size: 28px; font-weight: 600; color: #111827; margin-bottom: 8px;">Generate Use Case Diagram & User Story</h1>
        <p style="color: #6b7280; font-size: 14px;">Review your system logic and generated diagram before proceeding to the next design stage.</p>
    </div>
    
    <!-- Debug Alert -->
    <div id="debugAlert" class="debug-alert">
        <strong>Debug Mode:</strong> <span id="debugMessage"></span>
    </div>
    
    <div class="info-text">
        <p><strong>Note:</strong> Diagram Use Case dan User Story dihasilkan secara otomatis berdasarkan data yang telah Anda input sebelumnya. Fitur yang sama digunakan oleh beberapa aktor akan muncul sebagai <strong>satu use case</strong> dengan <strong>multiple associations</strong>.</p>
    </div>
    
    <!-- Use Case Diagram Section -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Use Case Diagram</div>
            <div class="action-buttons">
                <button class="btn" id="regenerateDiagram">
                    ‚Üª Regenerate Diagram
                </button>
                <button class="btn btn-outline" id="downloadDiagram">
                    ‚Üì Download SVG
                </button>
            </div>
        </div>
        
        <div class="diagram-container" id="diagramContainer">
            <div class="empty-state">
                <i>üìä</i>
                <p>Use Case Diagram will appear here</p>
            </div>
        </div>
    </div>
    
    <!-- Use Case Details Section -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Use Case Details</div>
            <div class="action-buttons">
                <button class="btn" id="regenerateText">
                    ‚Üª Regenerate Text
                </button>
                <button class="btn btn-outline" id="downloadText">
                    ‚Üì Download TXT
                </button>
            </div>
        </div>
        
        <div id="useCaseTableContainer">
            <!-- Tabel use case akan ditampilkan di sini -->
        </div>
        
        <!-- User Story Section -->
        <div class="user-story-section">
            <div class="user-story-header">
                <div class="user-story-title">User Story</div>
                <div class="action-buttons">
                    <button class="btn btn-outline" id="downloadUserStory">
                        ‚Üì Download TXT
                    </button>
                </div>
            </div>
            
            <div id="userStoryContainer">
                <!-- User story akan ditampilkan di sini -->
            </div>
        </div>
    </div>
    
    <div class="navigation">
        <button class="btn btn-outline" id="backButton">
            ‚Üê Back
        </button>
        <button class="btn" id="nextButton">
            Next ‚Üí
        </button>
    </div>
    
</main>

<footer>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <p style="font-size: 12px; color: #6b7280;">¬© 2025 One UML. All rights reserved.</p>
        <div style="display: flex; gap: 24px;">
            <a href="#" style="font-size: 12px; color: #6b7280; text-decoration: none;">Help</a>
            <a href="#" style="font-size: 12px; color: #6b7280; text-decoration: none;">Privacy</a>
            <a href="#" style="font-size: 12px; color: #6b7280; text-decoration: none;">Terms</a>
        </div>
    </div>
</footer>

<script>
// ============================================
// VARIABLES GLOBAL
// ============================================
let useCases = [];
let currentPlantUMLUrl = '';
let currentPlantUMLCode = '';

// ============================================
// DEBUG FUNCTIONS
// ============================================

function showDebugMessage(message) {
    const debugAlert = document.getElementById('debugAlert');
    const debugMessage = document.getElementById('debugMessage');
    debugMessage.textContent = message;
    debugAlert.style.display = 'block';
    setTimeout(() => {
        debugAlert.style.display = 'none';
    }, 5000);
}

function debugStorage() {
    console.log('üîç === DEBUG STORAGE ===');
    
    // Check localStorage
    console.log('üì¶ localStorage:');
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        console.log(`  ${key}:`, value);
    }
    
    // Check sessionStorage
    console.log('üì¶ sessionStorage:');
    for (let i = 0; i < sessionStorage.length; i++) {
        const key = sessionStorage.key(i);
        const value = sessionStorage.getItem(key);
        console.log(`  ${key}:`, value);
    }
    
    console.log('üìä Current useCases:', useCases);
    console.log('üìä Current useCases length:', useCases.length);
    console.log('üîö === END DEBUG ===');
}

// ============================================
// DATA LOADING FUNCTIONS
// ============================================

function loadUseCasesFromPreviousPage() {
    console.log('üîÑ Loading use cases from storage...');
    
    // Priority 1: Check URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const urlData = urlParams.get('useCases');
    if (urlData) {
        try {
            useCases = JSON.parse(decodeURIComponent(urlData));
            console.log('‚úÖ Loaded from URL:', useCases.length, 'use cases');
            showDebugMessage(`Loaded ${useCases.length} use cases from URL`);
            return true;
        } catch (e) {
            console.error('‚ùå Error parsing URL data:', e);
        }
    }
    
    // Priority 2: Check sessionStorage (temporary)
    const sessionData = sessionStorage.getItem('currentUseCases');
    if (sessionData) {
        try {
            useCases = JSON.parse(sessionData);
            console.log('‚úÖ Loaded from sessionStorage:', useCases.length, 'use cases');
            showDebugMessage(`Loaded ${useCases.length} use cases from session`);
            return true;
        } catch (e) {
            console.error('‚ùå Error parsing sessionStorage:', e);
        }
    }
    
    // Priority 3: Check localStorage 'actorsAndFeatures' (form data)
    const actorsData = localStorage.getItem('actorsAndFeatures');
    if (actorsData) {
        try {
            const actors = JSON.parse(actorsData);
            useCases = [];
            let hasValidData = false;
            
            actors.forEach(actor => {
                if (actor.name && actor.name.trim() !== '') {
                    actor.features.forEach(feature => {
                        if (feature.what && feature.what.trim() !== '') {
                            useCases.push({
                                actor: actor.name,
                                feature: feature.what,
                                purpose: feature.why || ''
                            });
                            hasValidData = true;
                        }
                    });
                }
            });
            
            if (hasValidData) {
                console.log('‚úÖ Loaded from actorsAndFeatures:', useCases.length, 'use cases');
                showDebugMessage(`Loaded ${useCases.length} use cases from form data`);
                // Save to sessionStorage for next time
                sessionStorage.setItem('currentUseCases', JSON.stringify(useCases));
                return true;
            }
        } catch (e) {
            console.error('‚ùå Error parsing actorsAndFeatures:', e);
        }
    }
    
    // Priority 4: Check localStorage 'useCases'
    const savedUseCases = localStorage.getItem('useCases');
    if (savedUseCases) {
        try {
            useCases = JSON.parse(savedUseCases);
            console.log('‚úÖ Loaded from useCases:', useCases.length, 'use cases');
            showDebugMessage(`Loaded ${useCases.length} use cases from saved data`);
            return true;
        } catch (e) {
            console.error('‚ùå Error parsing useCases:', e);
        }
    }
    
    // Priority 5: Check localStorage 'generatedUseCaseData'
    const generatedData = localStorage.getItem('generatedUseCaseData');
    if (generatedData) {
        try {
            const data = JSON.parse(generatedData);
            useCases = data.useCases || [];
            currentPlantUMLCode = data.plantUMLCode || '';
            currentPlantUMLUrl = data.plantUMLUrl || '';
            console.log('‚úÖ Loaded from generatedUseCaseData:', useCases.length, 'use cases');
            showDebugMessage(`Loaded ${useCases.length} use cases from generated data`);
            return true;
        } catch (e) {
            console.error('‚ùå Error parsing generatedUseCaseData:', e);
        }
    }
    
    console.log('‚ùå No data found in any storage');
    showDebugMessage('No data found. Please go back and define actors first.');
    return false;
}

// ============================================
// DISPLAY FUNCTIONS
// ============================================

function populateUseCaseTable() {
    const container = document.getElementById('useCaseTableContainer');
    
    if (useCases.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i>üìã</i>
                <p>No use case data available.</p>
                <p>Please go back and define actors and features first.</p>
            </div>
        `;
        return;
    }
    
    let tableHTML = `
        <table class="use-case-table">
            <thead>
                <tr>
                    <th>Actor</th>
                    <th>Feature</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    useCases.forEach(useCase => {
        tableHTML += `
            <tr>
                <td>${useCase.actor}</td>
                <td>${useCase.feature}</td>
                <td>${useCase.purpose || '<em style="color: #6b7280;">(optional - not specified)</em>'}</td>
            </tr>
        `;
    });
    
    tableHTML += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHTML;
}

function populateUserStories() {
    const container = document.getElementById('userStoryContainer');
    
    if (useCases.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i>üìù</i>
                <p>No user stories available.</p>
                <p>Please go back and define actors and features first.</p>
            </div>
        `;
        return;
    }
    
    let storiesHTML = `<ul class="user-story-list">`;
    
    useCases.forEach(useCase => {
        let storyText;
        if (useCase.purpose && useCase.purpose.trim() !== '') {
            storyText = `<strong>As a ${useCase.actor}</strong>, I want to ${useCase.feature.toLowerCase()}, so that ${useCase.purpose.toLowerCase()}.`;
        } else {
            storyText = `<strong>As a ${useCase.actor}</strong>, I want to ${useCase.feature.toLowerCase()}.`;
        }
        
        storiesHTML += `
            <li class="user-story-item">
                <span class="success-check">‚úî</span>
                <div>
                    ${storyText}
                </div>
            </li>
        `;
    });
    
    storiesHTML += `</ul>`;
    container.innerHTML = storiesHTML;
}

// ============================================
// PLANTUML FUNCTIONS
// ============================================

function encodePlantUML(text) {
    if (typeof pako !== 'undefined') {
        try {
            const deflated = pako.deflate(text, { level: 9 });
            const encoded = encode64(deflated);
            return '~1' + encoded;
        } catch (e) {
            console.warn('pako deflate failed, using fallback', e);
        }
    }
    
    const bytes = new TextEncoder().encode(text);
    let base64 = btoa(String.fromCharCode(...bytes));
    base64 = base64.replace(/\+/g, '-').replace(/\//g, '_');
    return '~1' + base64;
}

function encode64(data) {
    const tbl = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_";
    let res = "";
    for (let i = 0; i < data.length; i += 3) {
        if (i + 2 === data.length) {
            res += append3bytes(data[i], data[i + 1], 0, tbl).substring(0, 3);
        } else if (i + 1 === data.length) {
            res += append3bytes(data[i], 0, 0, tbl).substring(0, 2);
        } else {
            res += append3bytes(data[i], data[i + 1], data[i + 2], tbl);
        }
    }
    return res;
}

function append3bytes(b1, b2, b3, tbl) {
    const c1 = b1 >> 2;
    const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
    const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
    const c4 = b3 & 0x3F;
    return tbl[c1] + tbl[c2] + tbl[c3] + tbl[c4];
}

function generatePlantUMLUrl(plantUMLCode) {
    const encoded = encodePlantUML(plantUMLCode);
    return `https://www.plantuml.com/plantuml/svg/${encoded}`;
}

function generatePlantUMLDiagram() {
    const container = document.getElementById('diagramContainer');
    const regenerateBtn = document.getElementById('regenerateDiagram');
    const originalText = regenerateBtn.innerHTML;
    
    // Show loading state
    regenerateBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';
    regenerateBtn.disabled = true;
    
    if (useCases.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i>üìä</i>
                <p>No diagram data available.</p>
                <p>Please go back and define actors and features first.</p>
            </div>
        `;
        regenerateBtn.innerHTML = originalText;
        regenerateBtn.disabled = false;
        return;
    }
    
    try {
        // Generate PlantUML code
        currentPlantUMLCode = `@startuml\nleft to right direction\nskinparam monochrome true\nskinparam shadowing false\nskinparam usecase {\n  BackgroundColor #F8F9FA\n  BorderColor #6B7280\n}\ntitle Use Case Diagram\n\n`;
        
        // Add all unique actors
        const actors = [...new Set(useCases.map(uc => uc.actor))];
        actors.forEach(actor => {
            const actorId = actor.replace(/\s+/g, '');
            currentPlantUMLCode += `actor "${actor}" as ${actorId}\n`;
        });
        
        // Identify unique features
        const uniqueFeatures = new Map();
        
        useCases.forEach((useCase) => {
            const featureKey = useCase.feature.trim().toLowerCase();
            if (!uniqueFeatures.has(featureKey)) {
                uniqueFeatures.set(featureKey, {
                    name: useCase.feature,
                    actors: new Set(),
                    id: `UC${uniqueFeatures.size + 1}`
                });
            }
            uniqueFeatures.get(featureKey).actors.add(useCase.actor);
        });
        
        // Create unique use cases
        uniqueFeatures.forEach((feature, key) => {
            currentPlantUMLCode += `usecase "${feature.name}" as ${feature.id}\n`;
        });
        
        // Connect actors to use cases
        uniqueFeatures.forEach((feature, key) => {
            feature.actors.forEach(actorName => {
                const actorId = actorName.replace(/\s+/g, '');
                currentPlantUMLCode += `${actorId} --> ${feature.id}\n`;
            });
        });
        
        currentPlantUMLCode += `@enduml`;
        
        console.log('PlantUML Code:', currentPlantUMLCode);
        
        // Generate URL
        currentPlantUMLUrl = generatePlantUMLUrl(currentPlantUMLCode);
        
        console.log('PlantUML URL:', currentPlantUMLUrl);
        
        // Display diagram
        container.innerHTML = `
            <img src="${currentPlantUMLUrl}" alt="Use Case Diagram" class="diagram-image" 
                 onerror="handleImageError(this)" 
                 onload="handleImageLoad(this)">
        `;
        
        showDebugMessage('Diagram generated successfully!');
        
    } catch (error) {
        console.error('Error generating PlantUML diagram:', error);
        showTextualRepresentation();
    } finally {
        // Restore button state
        regenerateBtn.innerHTML = originalText;
        regenerateBtn.disabled = false;
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

async function downloadSVG() {
    if (!currentPlantUMLUrl) {
        alert('No diagram available to download. Please generate a diagram first.');
        return;
    }
    
    const downloadBtn = document.getElementById('downloadDiagram');
    const originalText = downloadBtn.innerHTML;
    
    downloadBtn.innerHTML = '<span class="loading-spinner"></span> Downloading...';
    downloadBtn.disabled = true;
    
    try {
        const response = await fetch(currentPlantUMLUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const svgText = await response.text();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const fileName = `use_case_diagram_${timestamp}.svg`;
        
        const blob = new Blob([svgText], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('Diagram downloaded successfully');
        
    } catch (error) {
        console.error('Error downloading SVG:', error);
        
        try {
            const img = document.querySelector('.diagram-image');
            if (img && img.src) {
                const a = document.createElement('a');
                a.href = img.src;
                a.download = `use_case_diagram_${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                console.log('Downloaded as image fallback');
            } else {
                alert('Failed to download diagram. Please try regenerating the diagram first.');
            }
        } catch (fallbackError) {
            console.error('Fallback download also failed:', fallbackError);
            alert('Failed to download diagram. Please try again.');
        }
    } finally {
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
    }
}

function showTextualRepresentation() {
    const container = document.getElementById('diagramContainer');
    
    const actors = [...new Set(useCases.map(uc => uc.actor))];
    const uniqueFeatures = new Map();
    
    useCases.forEach((useCase) => {
        const featureKey = useCase.feature.trim().toLowerCase();
        if (!uniqueFeatures.has(featureKey)) {
            uniqueFeatures.set(featureKey, {
                name: useCase.feature,
                actors: new Set()
            });
        }
        uniqueFeatures.get(featureKey).actors.add(useCase.actor);
    });
    
    let diagramHTML = `
        <div style="text-align: center; padding: 20px;">
            <div style="margin-bottom: 20px;">
                <h3>Use Case Diagram Preview</h3>
                <p style="color: #6b7280;">Diagram representation based on your data</p>
            </div>
    `;
    
    diagramHTML += `<div style="margin-bottom: 20px;"><strong>Actors:</strong> ${actors.join(', ')}</div>`;
    
    diagramHTML += `<div style="margin-bottom: 20px;">`;
    diagramHTML += `<strong>Use Cases:</strong><br>`;
    let index = 1;
    uniqueFeatures.forEach((feature, key) => {
        diagramHTML += `${index}. ${feature.name}<br>`;
        index++;
    });
    diagramHTML += `</div>`;
    
    diagramHTML += `<div style="margin-bottom: 20px;">`;
    diagramHTML += `<strong>Relationships:</strong><br>`;
    uniqueFeatures.forEach((feature, key) => {
        const actorList = Array.from(feature.actors);
        actorList.forEach(actor => {
            diagramHTML += `‚Ä¢ ${actor} ‚Üí ${feature.name}<br>`;
        });
    });
    diagramHTML += `</div>`;
    
    diagramHTML += `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                <p><strong>Note:</strong> PlantUML service is currently unavailable.</p>
                <p>This is a textual representation of your use case diagram.</p>
            </div>
        </div>
    `;
    
    container.innerHTML = diagramHTML;
}

function handleImageLoad(img) {
    console.log('Diagram loaded successfully');
}

function handleImageError(img) {
    console.error('Failed to load diagram image');
    showTextualRepresentation();
}

// ============================================
// NAVIGATION FUNCTIONS
// ============================================

function saveDataForNextPage() {
    const saveData = {
        useCases: useCases,
        plantUMLCode: currentPlantUMLCode,
        plantUMLUrl: currentPlantUMLUrl,
        timestamp: new Date().toISOString()
    };
    
    // Save to multiple storages for redundancy
    localStorage.setItem('generatedUseCaseData', JSON.stringify(saveData));
    localStorage.setItem('useCases', JSON.stringify(useCases));
    sessionStorage.setItem('currentUseCases', JSON.stringify(useCases));
    sessionStorage.setItem('useCaseData', JSON.stringify(saveData));
    
    console.log('üíæ Data saved for next page:', saveData);
    showDebugMessage('Data saved successfully!');
    
    return saveData;
}

function goToDefineActors() {
    window.location.href = '/use-case-diagram/';
}

// ============================================
// EVENT LISTENERS
// ============================================

document.getElementById('regenerateDiagram').addEventListener('click', function() {
    generatePlantUMLDiagram();
});

document.getElementById('downloadDiagram').addEventListener('click', function() {
    downloadSVG();
});

document.getElementById('regenerateText').addEventListener('click', function() {
    const hasData = loadUseCasesFromPreviousPage();
    if (hasData) {
        populateUseCaseTable();
        populateUserStories();
        generatePlantUMLDiagram();
        alert('Use Case details and User Stories regenerated successfully!');
    } else {
        alert('No valid data found. Please go back and define actors and features first.');
    }
});

document.getElementById('downloadText').addEventListener('click', function() {
    if (useCases.length === 0) {
        alert('No use case details available to download.');
        return;
    }
    
    let textContent = "USE CASE DETAILS\n================\n\n";
    useCases.forEach((useCase, index) => {
        textContent += `${index + 1}. Actor: ${useCase.actor}\n`;
        textContent += `   Feature: ${useCase.feature}\n`;
        textContent += `   Purpose: ${useCase.purpose || '(not specified)'}\n\n`;
    });
    
    const blob = new Blob([textContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'use_case_details.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

document.getElementById('downloadUserStory').addEventListener('click', function() {
    if (useCases.length === 0) {
        alert('No user stories available to download.');
        return;
    }
    
    let storiesContent = "USER STORIES\n============\n\n";
    useCases.forEach((useCase, index) => {
        if (useCase.purpose && useCase.purpose.trim() !== '') {
            storiesContent += `${index + 1}. As a ${useCase.actor}, I want to ${useCase.feature.toLowerCase()}, so that ${useCase.purpose.toLowerCase()}.\n\n`;
        } else {
            storiesContent += `${index + 1}. As a ${useCase.actor}, I want to ${useCase.feature.toLowerCase()}.\n\n`;
        }
    });
    
    const blob = new Blob([storiesContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'user_stories.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

document.getElementById('backButton').addEventListener('click', function() {
    window.location.href = '/use-case-diagram/';
});

document.getElementById('nextButton').addEventListener('click', function() {
    if (useCases.length === 0) {
        const hasData = loadUseCasesFromPreviousPage();
        if (!hasData) {
            alert('No use case data found. Please go back to define actors and features first.');
            return;
        }
    }
    
    // Generate diagram if not yet generated
    if (!currentPlantUMLCode) {
        generatePlantUMLDiagram();
        setTimeout(() => {
            saveDataForNextPage();
            window.location.href = '/input-informasi-tambahan/';
        }, 1500);
    } else {
        saveDataForNextPage();
        window.location.href = '/input-informasi-tambahan/';
    }
});

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Page loaded - initializing...');
    
    // Check for forced refresh
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('forceRefresh')) {
        console.log('üîÑ Force refreshing data...');
        sessionStorage.clear();
        localStorage.removeItem('generatedUseCaseData');
        localStorage.removeItem('useCases');
        // Reload without parameter
        window.location.href = window.location.pathname;
        return;
    }
    
    // Load data
    const hasData = loadUseCasesFromPreviousPage();
    
    if (hasData) {
        console.log('‚úÖ Data loaded successfully');
        
        // Populate tables
        populateUseCaseTable();
        populateUserStories();
        
        // Generate diagram
        setTimeout(() => {
            generatePlantUMLDiagram();
        }, 300);
    } else {
        console.log('‚ö†Ô∏è No data found');
        
        // Show empty state
        populateUseCaseTable();
        populateUserStories();
        
        const diagramContainer = document.getElementById('diagramContainer');
        diagramContainer.innerHTML = `
            <div class="empty-state">
                <i>üìä</i>
                <p>No diagram data available.</p>
                <p>Please go back and define actors and features first.</p>
                <button class="btn" onclick="goToDefineActors()" style="margin-top: 10px;">
                    Go to Define Actors
                </button>
            </div>
        `;
    }
});
</script>

<!-- Tambahkan library pako.js untuk kompresi DEFLATE -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

</body>
</html>