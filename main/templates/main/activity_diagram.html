{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generated Activity Diagram - OneUML</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f9f9f9;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 24px;
      color: #1f2937;
      gap: 8px;
    }
    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .content-section {
      background-color: #fff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-top: 32px;
    }
    .preview-container {
      background-color: #fafafa;
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 48px;
      text-align: center;
      min-height: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .preview-container img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .placeholder-icon {
      font-size: 80px;
      color: #ccc;
      margin-bottom: 20px;
    }
    .btn-dark {
      background-color: #1f2937;
      color: #fff;
      border: none;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-dark:hover {
      background-color: #111827;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-light-outline {
      background-color: #fff;
      color: #374151;
      border: 1px solid #d1d5db;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-light-outline:hover {
      background-color: #f3f4f6;
      border-color: #9ca3af;
    }
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 48px;
      padding: 24px 0;
    }
    .action-buttons {
      display: flex;
      gap: 16px;
      margin-top: 32px;
      justify-content: center;
    }
    .toolbar-icons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .toolbar-icons button {
      background: #fff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      width: 38px;
      height: 38px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }
    .toolbar-icons button:hover {
      background-color: #f3f4f6;
      border-color: #9ca3af;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    #plantUMLCode {
      display: none;
    }
    .tip-text {
      color: #6b7280;
      font-size: 14px;
      margin-top: 24px;
      padding: 16px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .container {
      flex: 1;
    }
    .page-title {
      color: #1f2937;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .page-subtitle {
      color: #6b7280;
      font-size: 15px;
    }
    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 16px;
      color: #991b1b;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      ‚ö° OneUML
    </div>
    <div>
      <img src="https://via.placeholder.com/40" alt="Profile" class="profile-img">
    </div>
  </header>

  <!-- Content -->
  <div class="container">
    <div class="content-section">
      <h3 class="page-title">Generated Activity Diagram</h3>
      <p class="page-subtitle">Preview the generated activity diagram or download its PlantUML source for further editing.</p>

      <div class="preview-header">
        <h5 class="fw-bold mb-0">Activity Diagram Preview</h5>
        <div class="toolbar-icons">
          <button id="zoomInBtn" title="Zoom In">üîç+</button>
          <button id="zoomOutBtn" title="Zoom Out">üîç‚àí</button>
          <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
          <button id="refreshBtn" title="Refresh">‚Üª</button>
          <button id="infoBtn" title="Info">‚ìò</button>
        </div>
      </div>

      <div class="preview-container" id="previewContainer">
        <div class="placeholder-icon">üñºÔ∏è</div>
        <p class="text-muted">Activity Diagram Preview will appear here</p>
        <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
        <img id="diagramImage" style="display: none;" alt="Activity Diagram">
      </div>

      <div class="tip-text text-center">
        üí° <strong>Tip:</strong> Click 'Download PlantUML' to get editable source code. You can paste it into PlantUML editors for further customization.
      </div>

      <!-- PlantUML Code (hidden) -->
      <textarea id="plantUMLCode" class="form-control" rows="15"></textarea>

      <div class="action-buttons">
        <button class="btn btn-dark" id="downloadPlantUMLBtn">
          <span>üì•</span> Download PlantUML
        </button>
        <button class="btn btn-light-outline" id="exportPNGBtn">
          <span>üìÑ</span> Export as PNG
        </button>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-buttons container">
      <button class="btn btn-light-outline px-4 py-2" id="backBtn">‚Üê Back</button>
      <button class="btn btn-dark px-4 py-2" id="nextBtn">Next ‚Üí</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
  <script>
    // ===== AMBIL DATA DARI DJANGO CONTEXT =====
    const allFeaturesRaw = '{{ all_features|escapejs }}';
    let allFeatures = [];

    if (allFeaturesRaw && allFeaturesRaw !== '[]') {
        try {
            allFeatures = JSON.parse(allFeaturesRaw);
        } catch(e) {
            console.error("Error parsing data:", e);
        }
    }

    console.log("=== ALL FEATURES ===");
    console.log(allFeatures);
    console.log("=====================");

    // ===== GENERATE PLANTUML CODE =====
    function generatePlantUML(data) {
      let plantUML = "@startuml\n";
      plantUML += "title Activity Diagram - " + data.featureName + "\n\n";
      
      // Start event
      plantUML += "start\n";
      
      // Pre-condition (START EVENT)
      if (data.precondition && data.precondition.trim()) {
        plantUML += ":" + data.precondition + ";\n";
      }
      plantUML += "\n";

      // Basic Path
      if (data.basicPath && data.basicPath.length > 0) {
        plantUML += 'partition "Basic Flow" {\n';
        data.basicPath.forEach((step) => {
          if (step.actor && step.actor.trim()) {
            plantUML += "  :" + step.actor + ";\n";
          }
          if (step.system && step.system.trim()) {
            plantUML += "  :" + step.system + ";\n";
          }
        });
        plantUML += "}\n\n";
      }

      // Alternative Path
      if (data.alternativePath && data.alternativePath.length > 0) {
        const hasAlternativeContent = data.alternativePath.some(step => 
          (step.actor && step.actor.trim()) || (step.system && step.system.trim())
        );
        
        if (hasAlternativeContent) {
          plantUML += 'partition "Alternative Flow" {\n';
          data.alternativePath.forEach((step) => {
            if (step.actor && step.actor.trim()) {
              plantUML += "  :" + step.actor + ";\n";
            }
            if (step.system && step.system.trim()) {
              plantUML += "  :" + step.system + ";\n";
            }
          });
          plantUML += "}\n\n";
        }
      }

      // Exception Path
      if (data.exceptionPath && data.exceptionPath.length > 0) {
        const hasExceptionContent = data.exceptionPath.some(step => 
          (step.actor && step.actor.trim()) || (step.system && step.system.trim())
        );
        
        if (hasExceptionContent) {
          plantUML += 'partition "Exception Flow" {\n';
          data.exceptionPath.forEach((step) => {
            if (step.actor && step.actor.trim()) {
              plantUML += "  :" + step.actor + ";\n";
            }
            if (step.system && step.system.trim()) {
              plantUML += "  :" + step.system + ";\n";
            }
          });
          plantUML += "}\n\n";
        }
      }

      // Post-condition (END EVENT)
      if (data.postcondition && data.postcondition.trim()) {
        plantUML += ":" + data.postcondition + ";\n";
      }
      
      // End event
      plantUML += "stop\n";
      plantUML += "@enduml";

      return plantUML;
    }

    // ===== RENDER DIAGRAM =====
    async function renderDiagram(plantUMLCode) {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const diagramImage = document.getElementById('diagramImage');
      const previewContainer = document.getElementById('previewContainer');
      
      // Show loading
      loadingSpinner.style.display = 'block';
      diagramImage.style.display = 'none';
      const placeholderIcon = previewContainer.querySelector('.placeholder-icon');
      const placeholderText = previewContainer.querySelector('p');
      if (placeholderIcon) placeholderIcon.style.display = 'none';
      if (placeholderText) placeholderText.style.display = 'none';

      try {
        // Encode PlantUML code
        const encoded = encodePlantUML(plantUMLCode);
        const imageUrl = `https://www.plantuml.com/plantuml/png/${encoded}`;
        
        console.log("PlantUML URL:", imageUrl);
        
        // Load image
        diagramImage.src = imageUrl;
        diagramImage.onload = function() {
          loadingSpinner.style.display = 'none';
          diagramImage.style.display = 'block';
        };
        
        diagramImage.onerror = function() {
          loadingSpinner.style.display = 'none';
          previewContainer.innerHTML += `
            <div class="error-message">
              <strong>‚ö†Ô∏è Failed to render diagram</strong><br>
              Please check your internet connection or try again later.
            </div>`;
        };
      } catch (error) {
        console.error('Error rendering diagram:', error);
        loadingSpinner.style.display = 'none';
        alert('Error generating diagram: ' + error.message);
      }
    }

    // ===== PLANTUML ENCODING FUNCTIONS =====
    function encodePlantUML(text) {
      return plantumlEncoder.encode(text);
    }

    // ===== RENDER DIAGRAM FOR SPECIFIC INDEX =====
    function renderDiagramForIndex(plantUMLCode, index) {
        const spinner = document.getElementById(`spinner${index}`);
        const img = document.getElementById(`diagram${index}`);
        
        try {
            const encoded = encodePlantUML(plantUMLCode);
            const imageUrl = `https://www.plantuml.com/plantuml/png/${encoded}`;
            
            img.src = imageUrl;
            img.onload = function() {
                spinner.style.display = 'none';
                img.style.display = 'block';
            };
            
            img.onerror = function() {
                spinner.style.display = 'none';
                img.parentElement.innerHTML += `<p style="color: #991b1b;">Failed to render diagram ${index + 1}</p>`;
            };
        } catch (error) {
            console.error(`Error rendering diagram ${index}:`, error);
            spinner.style.display = 'none';
        }
    }

    // ===== INITIALIZE =====
    document.addEventListener('DOMContentLoaded', function() {
        const previewContainer = document.getElementById('previewContainer');
        
        if (allFeatures && allFeatures.length > 0) {
            // Clear container
            previewContainer.innerHTML = '';
            
            // ‚úÖ Render diagram untuk setiap feature
            allFeatures.forEach((feature, index) => {
                const plantUMLCode = generatePlantUML(feature);
                
                // Store PlantUML code untuk download (ambil yang pertama saja)
                if (index === 0) {
                    document.getElementById('plantUMLCode').value = plantUMLCode;
                }
                
                // Create container untuk setiap diagram
                const diagramDiv = document.createElement('div');
                diagramDiv.style.marginBottom = '40px';
                diagramDiv.innerHTML = `
                    <h5 style="margin-bottom: 16px; color: #1f2937; font-weight: 600;">Feature ${index + 1}: ${feature.featureName}</h5>
                    <div style="background: #fafafa; border: 2px dashed #ddd; border-radius: 12px; padding: 24px; text-align: center; min-height: 300px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div class="loading-spinner" id="spinner${index}"></div>
                        <img id="diagram${index}" style="display: none; max-width: 100%; height: auto;" alt="Activity Diagram ${index + 1}">
                    </div>
                `;
                previewContainer.appendChild(diagramDiv);
                
                // Render diagram
                renderDiagramForIndex(plantUMLCode, index);
            });
        } else {
            previewContainer.innerHTML = `
                <div class="error-message">
                    <strong>‚ö†Ô∏è No use case data found</strong><br>
                    Please go back and fill in the information first.
                </div>`;
        }
    });

    // ===== DOWNLOAD PLANTUML =====
    document.getElementById('downloadPlantUMLBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            // Download semua PlantUML code dalam 1 file
            let allPlantUML = '';
            allFeatures.forEach((feature, index) => {
                const code = generatePlantUML(feature);
                allPlantUML += `\n' ========== Feature ${index + 1}: ${feature.featureName} ==========\n`;
                allPlantUML += code + '\n\n';
            });
            
            const blob = new Blob([allPlantUML], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'all_activity_diagrams.puml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            alert('No diagrams to download.');
        }
    });

    // ===== EXPORT PNG =====
    document.getElementById('exportPNGBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            // Download diagram pertama sebagai PNG
            const img = document.getElementById('diagram0');
            if (img && img.src && img.style.display !== 'none') {
                const a = document.createElement('a');
                a.href = img.src;
                a.download = 'activity_diagram.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('Please wait for the diagram to load first.');
            }
        } else {
            alert('No diagrams to export.');
        }
    });

    // ===== TOOLBAR BUTTONS =====
    document.getElementById('refreshBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            allFeatures.forEach((feature, index) => {
                const plantUMLCode = generatePlantUML(feature);
                renderDiagramForIndex(plantUMLCode, index);
            });
        }
    });

    document.getElementById('zoomInBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            allFeatures.forEach((feature, index) => {
                const img = document.getElementById(`diagram${index}`);
                if (img && img.style.display !== 'none') {
                    const currentWidth = img.width || img.naturalWidth;
                    img.style.width = (currentWidth * 1.2) + 'px';
                }
            });
        }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            allFeatures.forEach((feature, index) => {
                const img = document.getElementById(`diagram${index}`);
                if (img && img.style.display !== 'none') {
                    const currentWidth = img.width || img.naturalWidth;
                    img.style.width = (currentWidth * 0.8) + 'px';
                }
            });
        }
    });

    document.getElementById('fullscreenBtn').addEventListener('click', function() {
        // Fullscreen untuk diagram pertama
        const img = document.getElementById('diagram0');
        if (img && img.style.display !== 'none') {
            if (img.requestFullscreen) {
                img.requestFullscreen();
            } else if (img.webkitRequestFullscreen) {
                img.webkitRequestFullscreen();
            } else if (img.msRequestFullscreen) {
                img.msRequestFullscreen();
            }
        }
    });

    document.getElementById('infoBtn').addEventListener('click', function() {
        if (allFeatures && allFeatures.length > 0) {
            let info = `Total Features: ${allFeatures.length}\n\n`;
            allFeatures.forEach((feature, index) => {
                info += `Feature ${index + 1}:\n`;
                info += `  Name: ${feature.featureName}\n`;
                info += `  Priority: ${feature.priority}\n`;
                info += `  Status: ${feature.status}\n\n`;
            });
            alert(info);
        } else {
            alert('No features to display.');
        }
    });

    // ===== NAVIGATION BUTTONS =====
    document.getElementById('backBtn').addEventListener('click', function() {
        window.location.href = "{% url 'main:use_case_spec' %}";
    });

    document.getElementById('nextBtn').addEventListener('click', function() {
        window.location.href = "{% url 'main:input_gui' %}";
    });
  </script>
</body>
</html>