<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generated Activity Diagram</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f9f9f9;
      font-family: "Arial", sans-serif;
    }
    .header {
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      border-bottom: 1px solid #ddd;
    }
    .logo {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 20px;
    }
    .logo img {
      height: 35px;
      margin-right: 10px;
    }
    .profile-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ccc;
    }
    .content-section {
      background-color: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
      margin-top: 30px;
    }
    .preview-container {
      background-color: #fafafa;
      border: 1px dashed #ddd;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .preview-container img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }
    .placeholder-icon {
      font-size: 80px;
      color: #ccc;
      margin-bottom: 20px;
    }
    .btn-dark {
      background-color: #000;
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 6px;
      font-weight: 500;
    }
    .btn-light-outline {
      background-color: #fff;
      color: #333;
      border: 1px solid #ddd;
      padding: 12px 30px;
      border-radius: 6px;
      font-weight: 500;
    }
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
    }
    .toolbar-icons {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toolbar-icons button {
      background: none;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 35px;
      height: 35px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .toolbar-icons button:hover {
      background-color: #f0f0f0;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #plantUMLCode {
      display: none;
    }
    .tip-text {
      color: #999;
      font-size: 14px;
      margin-top: 20px;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #000;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg" alt="OneUML Logo">
      OneUML
    </div>
    <div>
      <img src="https://via.placeholder.com/40" alt="Profile" class="profile-img">
    </div>
  </header>

  <!-- Content -->
  <div class="container">
    <div class="content-section">
      <h3 class="fw-bold">Generated Activity Diagram</h3>
      <p class="text-muted">Preview the generated activity diagram or download its PlantUML source for further editing.</p>

      <div class="preview-header">
        <h5 class="fw-bold mb-0">Activity Diagram Preview</h5>
        <div class="toolbar-icons">
          <button id="zoomInBtn" title="Zoom In">üîç+</button>
          <button id="zoomOutBtn" title="Zoom Out">üîç-</button>
          <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
          <button id="refreshBtn" title="Refresh">‚Üª</button>
          <button id="infoBtn" title="Info">‚ìò</button>
        </div>
      </div>

      <div class="preview-container" id="previewContainer">
        <div class="placeholder-icon">üñºÔ∏è</div>
        <p class="text-muted">Activity Diagram Preview will appear here</p>
        <div class="loading-spinner" id="loadingSpinner" style="display: none;"></div>
        <img id="diagramImage" style="display: none;" alt="Activity Diagram">
      </div>

      <p class="tip-text text-center">
        Tip: Click 'Download PlantUML' to get editable source; use 'Copy Source' to paste into PlantUML editors.
      </p>

      <!-- PlantUML Code (hidden) -->
      <textarea id="plantUMLCode" class="form-control" rows="15"></textarea>

      <div class="action-buttons">
        <button class="btn btn-dark" id="downloadPlantUMLBtn">
          <span>üì•</span> Download PlantUML
        </button>
        <button class="btn btn-light-outline" id="exportPNGBtn">
          <span>üìÑ</span> Export as PNG
        </button>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-buttons">
      <button class="btn btn-light-outline px-4 py-2" id="backBtn">‚Üê Back</button>
      <button class="btn btn-dark px-4 py-2" id="nextBtn">Next ‚Üí</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Fungsi untuk membuat PlantUML dari data use case
    function generatePlantUML(data) {
      let plantUML = "@startuml\n";
      plantUML += "title Activity Diagram - " + data.featureName + "\n\n";
      
      // Start event dari pre-condition
      plantUML += "start\n";
      if (data.precondition && data.precondition.trim()) {
        plantUML += ":" + data.precondition + ";\n";
      }
      plantUML += "\n";

      // Basic Path - Actor dan System Actions
      if (data.basicPath && data.basicPath.length > 0) {
        plantUML += "partition \"Basic Flow\" {\n";
        data.basicPath.forEach((step, index) => {
          if (step.actor && step.actor.trim()) {
            plantUML += "  :" + step.actor + ";\n";
          }
          if (step.system && step.system.trim()) {
            plantUML += "  :" + step.system + ";\n";
          }
        });
        plantUML += "}\n\n";
      }

      // Alternative Path
      if (data.alternativePath && data.alternativePath.length > 0) {
        const hasAlternativeContent = data.alternativePath.some(step => 
          (step.actor && step.actor.trim()) || (step.system && step.system.trim())
        );
        
        if (hasAlternativeContent) {
          plantUML += "partition \"Alternative Flow\" {\n";
          data.alternativePath.forEach((step, index) => {
            if (step.actor && step.actor.trim()) {
              plantUML += "  :" + step.actor + ";\n";
            }
            if (step.system && step.system.trim()) {
              plantUML += "  :" + step.system + ";\n";
            }
          });
          plantUML += "}\n\n";
        }
      }

      // Exception Path
      if (data.exceptionPath && data.exceptionPath.length > 0) {
        const hasExceptionContent = data.exceptionPath.some(step => 
          (step.actor && step.actor.trim()) || (step.system && step.system.trim())
        );
        
        if (hasExceptionContent) {
          plantUML += "partition \"Exception Flow\" {\n";
          data.exceptionPath.forEach((step, index) => {
            if (step.actor && step.actor.trim()) {
              plantUML += "  :" + step.actor + ";\n";
            }
            if (step.system && step.system.trim()) {
              plantUML += "  :" + step.system + ";\n";
            }
          });
          plantUML += "}\n\n";
        }
      }

      // End event dari post-condition
      if (data.postcondition && data.postcondition.trim()) {
        plantUML += ":" + data.postcondition + ";\n";
      }
      plantUML += "stop\n";
      plantUML += "@enduml";

      return plantUML;
    }

    // Fungsi untuk menghasilkan diagram menggunakan PlantUML server
    async function renderDiagram(plantUMLCode) {
      const loadingSpinner = document.getElementById('loadingSpinner');
      const diagramImage = document.getElementById('diagramImage');
      const previewContainer = document.getElementById('previewContainer');
      
      // Show loading
      loadingSpinner.style.display = 'block';
      diagramImage.style.display = 'none';
      previewContainer.querySelector('.placeholder-icon').style.display = 'none';
      previewContainer.querySelector('p').style.display = 'none';

      try {
        // Encode PlantUML code
        const encoded = encodePlantUML(plantUMLCode);
        const imageUrl = `https://www.plantuml.com/plantuml/png/${encoded}`;
        
        // Load image
        diagramImage.src = imageUrl;
        diagramImage.onload = function() {
          loadingSpinner.style.display = 'none';
          diagramImage.style.display = 'block';
        };
        
        diagramImage.onerror = function() {
          loadingSpinner.style.display = 'none';
          alert('Failed to render diagram. Please check your internet connection.');
          previewContainer.querySelector('.placeholder-icon').style.display = 'block';
          previewContainer.querySelector('p').style.display = 'block';
        };
      } catch (error) {
        console.error('Error rendering diagram:', error);
        loadingSpinner.style.display = 'none';
        alert('Error generating diagram: ' + error.message);
      }
    }

    // PlantUML encoding function (deflate + base64)
    function encodePlantUML(text) {
      // Simple encoding for PlantUML
      const compressed = pako.deflate(text, { level: 9 });
      return encode64(compressed);
    }

    function encode64(data) {
      let r = "";
      for (let i = 0; i < data.length; i += 3) {
        if (i + 2 === data.length) {
          r += append3bytes(data[i], data[i + 1], 0);
        } else if (i + 1 === data.length) {
          r += append3bytes(data[i], 0, 0);
        } else {
          r += append3bytes(data[i], data[i + 1], data[i + 2]);
        }
      }
      return r;
    }

    function append3bytes(b1, b2, b3) {
      const c1 = b1 >> 2;
      const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
      const c3 = ((b2 & 0xf) << 2) | (b3 >> 6);
      const c4 = b3 & 0x3f;
      let r = "";
      r += encode6bit(c1 & 0x3f);
      r += encode6bit(c2 & 0x3f);
      r += encode6bit(c3 & 0x3f);
      r += encode6bit(c4 & 0x3f);
      return r;
    }

    function encode6bit(b) {
      if (b < 10) return String.fromCharCode(48 + b);
      b -= 10;
      if (b < 26) return String.fromCharCode(65 + b);
      b -= 26;
      if (b < 26) return String.fromCharCode(97 + b);
      b -= 26;
      if (b === 0) return "-";
      if (b === 1) return "_";
      return "?";
    }

    // Load data dari localStorage saat halaman dimuat
    document.addEventListener('DOMContentLoaded', function() {
      const savedData = localStorage.getItem('useCaseData');
      
      if (savedData) {
        const data = JSON.parse(savedData);
        const plantUMLCode = generatePlantUML(data);
        
        // Set PlantUML code ke textarea (tersembunyi)
        document.getElementById('plantUMLCode').value = plantUMLCode;
        
        // Render diagram
        renderDiagram(plantUMLCode);
      } else {
        alert('No use case data found. Please go back and fill in the information.');
      }
    });

    // Download PlantUML source
    document.getElementById('downloadPlantUMLBtn').addEventListener('click', function() {
      const plantUMLCode = document.getElementById('plantUMLCode').value;
      const blob = new Blob([plantUMLCode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'activity_diagram.puml';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Export as PNG
    document.getElementById('exportPNGBtn').addEventListener('click', function() {
      const img = document.getElementById('diagramImage');
      if (img.src && img.style.display !== 'none') {
        const a = document.createElement('a');
        a.href = img.src;
        a.download = 'activity_diagram.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else {
        alert('Please wait for the diagram to load first.');
      }
    });

    // Toolbar buttons
    document.getElementById('refreshBtn').addEventListener('click', function() {
      const plantUMLCode = document.getElementById('plantUMLCode').value;
      renderDiagram(plantUMLCode);
    });

    document.getElementById('zoomInBtn').addEventListener('click', function() {
      const img = document.getElementById('diagramImage');
      const currentWidth = img.width || img.naturalWidth;
      img.style.width = (currentWidth * 1.2) + 'px';
    });

    document.getElementById('zoomOutBtn').addEventListener('click', function() {
      const img = document.getElementById('diagramImage');
      const currentWidth = img.width || img.naturalWidth;
      img.style.width = (currentWidth * 0.8) + 'px';
    });

    document.getElementById('fullscreenBtn').addEventListener('click', function() {
      const img = document.getElementById('diagramImage');
      if (img.requestFullscreen) {
        img.requestFullscreen();
      }
    });

    document.getElementById('infoBtn').addEventListener('click', function() {
      const savedData = localStorage.getItem('useCaseData');
      if (savedData) {
        const data = JSON.parse(savedData);
        alert(`Feature: ${data.featureName}\nPriority: ${data.priority}\nStatus: ${data.status}`);
      }
    });

    // Navigation buttons
    document.getElementById('backBtn').addEventListener('click', function() {
      window.history.back();
    });

    document.getElementById('nextBtn').addEventListener('click', function() {
      // Navigate to next page
      alert('Proceeding to next step...');
    });
  </script>
  
  <!-- Pako library for compression -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</body>
</html>